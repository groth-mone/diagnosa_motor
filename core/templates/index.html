{% extends 'base.html' %}

{% block title %}Smart Diagnosis System{% endblock %}

{% block content %}
<!-- Welcome Modal -->
<div class="modal fade" id="welcomeModal" tabindex="-1" aria-labelledby="welcomeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content welcome-modal">
      <div class="modal-header welcome-header">
        <div class="welcome-animation">
          <div class="welcome-circle">
            <div class="welcome-circle-inner">
              <i class="fas fa-heartbeat"></i>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body welcome-body">
        <div class="text-center mb-4">
          <h2 class="welcome-title">Selamat Datang di Smart Diagnosis System</h2>
          <p class="welcome-subtitle">Sistem Diagnosa Kerusakan Motor Matic Injeksi</p>
        </div>
        
        <div class="welcome-content">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fas fa-stethoscope"></i>
                </div>
                <h5>Diagnosa Akurat</h5>
                <p>Sistem menggunakan algoritma cerdas untuk memberikan diagnosa yang akurat berdasarkan gejala yang Anda pilih.</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fas fa-brain"></i>
                </div>
                <h5>AI Technology</h5>
                <p>Didukung dengan teknologi kecerdasan buatan yang terus belajar untuk hasil yang lebih baik.</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fas fa-shield-alt"></i>
                </div>
                <h5>Aman & Terpercaya</h5>
                <p>Data Anda aman dan sistem telah diverifikasi oleh para ahli profesional.</p>
              </div>
            </div>
            <div class="col-md-6">
              <div class="feature-card">
                <div class="feature-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <h5>Cepat & Efisien</h5>
                <p>Dapatkan hasil diagnosa dalam hitungan detik dengan proses yang mudah dan intuitif.</p>
              </div>
            </div>
          </div>
        </div>
        
        <div class="welcome-info mt-4">
          <div class="info-box">
            <h6><i class="fas fa-info-circle me-2"></i>Cara Menggunakan:</h6>
            <ol class="info-list">
              <li>Pilih gejala yang Anda rasakan dari daftar yang tersedia</li>
              <li>Klik tombol "Mulai Diagnosa" untuk memproses data</li>
              <li>Tunggu sistem menganalisis gejala Anda</li>
              <li>Dapatkan hasil diagnosa dan rekomendasi penanganan</li>
            </ol>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <button type="button" class="btn btn-primary btn-lg px-5" data-bs-dismiss="modal">
            <i class="fas fa-rocket me-2"></i>Mulai Sekarang
          </button>
        </div>
        
        <div class="welcome-footer mt-4 text-center">
          <p class="text-muted mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>
            <small>Hasil diagnosa ini hanya sebagai rujukan awal. Konsultasikan dengan mekanik ahli untuk diagnosis yang akurat.</small>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-md-12">
      <div class="tech-header">
        <div class="tech-dots"></div>
        <div class="tech-lines"></div>
        <h1>Smart Diagnosis System</h1>
        <p>Pilih gejala yang Anda alami untuk mendapatkan diagnosa dengan teknologi AI terkini.</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3>Pilih Gejala</h3>
          <div class="counter-badge" id="counterBadge">
            <i class="fas fa-check-circle me-2"></i>
            <span id="selectedCount">0</span> Gejala
          </div>
        </div>
        <div class="card-body">
          <form id="diagnosisForm" method="post" action="{% url 'proses_diagnosa' %}">
            {% csrf_token %}
            
            <div class="search-container">
              <i class="fas fa-search"></i>
              <input type="text" id="searchGejala" class="form-control" placeholder="Cari gejala...">
            </div>
            
              <div class="table-container" style="max-height: 300px; overflow-y: auto;">
              <table class="table table-striped table-hover">
                <tbody id="gejalaTable">
                  {% for g in gejala %}
                  <tr>
                    <td>
                      <div class="form-check">
                        <input class="form-check-input gejala-check" type="checkbox" name="gejala" id="gejala{{ g.id }}" value="{{ g.id }}">
                        <label class="form-check-label" for="gejala{{ g.id }}">{{ g.nama }}</label>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <div class="mt-4 d-flex">
              <button type="button" id="startDiagnosis" class="btn btn-primary px-4" disabled>
                <i class="fas fa-stethoscope me-2"></i> Mulai Diagnosa
              </button>
              <button type="reset" class="btn btn-outline-secondary ms-3">
                <i class="fas fa-redo me-1"></i> Reset
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Diagnosis Process Modal -->
  <div class="modal fade" id="diagnosisModal" tabindex="-1" aria-labelledby="diagnosisModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="diagnosisModalLabel">
            <i class="fas fa-laptop-medical me-2"></i> Proses Diagnosa
          </h5>
        </div>
        <div class="modal-body">
          <div class="diagnosis-animation">
            <div class="tech-circle">
              <div class="tech-circle-inner">
                <span id="progressPercent">0%</span>
              </div>
              <div class="tech-particles">
                <div class="tech-particle"></div>
                <div class="tech-particle"></div>
                <div class="tech-particle"></div>
                <div class="tech-particle"></div>
                <div class="tech-particle"></div>
              </div>
            </div>
          </div>

          <div class="progress">
            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
          </div>

          <div class="process-steps">
            <div class="process-step" id="step1">
              <div class="status-icon" id="icon1"></div>
              <h5>Pengumpulan Data Gejala</h5>
              <p id="text1" class="loading-dots">Mengumpulkan dan memverifikasi gejala yang dipilih</p>
            </div>
            <div class="process-step" id="step2">
              <div class="status-icon" id="icon2"></div>
              <h5>Pencocokan dengan Basis Pengetahuan</h5>
              <p id="text2">Mencari kecocokan gejala dalam basis pengetahuan sistem</p>
            </div>
            <div class="process-step" id="step3">
              <div class="status-icon" id="icon3"></div>
              <h5>Penghitungan Tingkat Kecocokan</h5>
              <p id="text3">Menghitung persentase kecocokan dengan rule yang ada</p>
            </div>
            <div class="process-step" id="step4">
              <div class="status-icon" id="icon4"></div>
              <h5>Analisis Diagnosis</h5>
              <p id="text4">Menganalisis gejala untuk menentukan diagnosis yang tepat</p>
            </div>
            <div class="process-step" id="step5">
              <div class="status-icon" id="icon5"></div>
              <h5>Penyusunan Hasil</h5>
              <p id="text5">Menyusun hasil diagnosis dan rekomendasi penanganan</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    var welcomeModal = document.getElementById('welcomeModal');
  if (welcomeModal) {
    var modal = new bootstrap.Modal(welcomeModal);
    modal.show();
  }
  const form = document.getElementById('diagnosisForm');
  const checkboxes = document.querySelectorAll('.gejala-check');
  const counterBadge = document.getElementById('counterBadge');
  const selectedCount = document.getElementById('selectedCount');
  const startButton = document.getElementById('startDiagnosis');
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');

  // Update counter when checkboxes are clicked
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateCounter);
  });

  function updateCounter() {
    const checkedCount = document.querySelectorAll('.gejala-check:checked').length;
    selectedCount.textContent = checkedCount;

    if (checkedCount > 0) {
      counterBadge.classList.add('active');
      startButton.disabled = false;
    } else {
      counterBadge.classList.remove('active');
      startButton.disabled = true;
    }
  }

  // Initialize counter
  updateCounter();

  // Start diagnosis process
  startButton.addEventListener('click', function() {
    const selectedSymptoms = document.querySelectorAll('.gejala-check:checked');

    if (selectedSymptoms.length === 0) {
      alert('Silakan pilih minimal satu gejala untuk melakukan diagnosa.');
      return;
    }

    // Reset progress dan step class
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', 0);
    progressPercent.textContent = '0%';
    
    document.querySelectorAll('.process-step').forEach(step => {
      step.classList.remove('active', 'completed');
    });
    
    document.querySelectorAll('.loading-dots').forEach(e => {
      e.classList.remove('loading-dots');
    });
    
    for (let i = 1; i <= 5; i++) {
      document.getElementById(`icon${i}`).innerHTML = '';
    }

    // Tampilkan modal
    const modal = new bootstrap.Modal(document.getElementById('diagnosisModal'));
    modal.show();

    // Jalankan animasi proses
    animateDiagnosisProcess();
  });

  function animateDiagnosisProcess() {
    const steps = [1, 2, 3, 4, 5];
    let currentStep = 0;
    const totalSteps = steps.length;

    const interval = setInterval(function() {
      if (currentStep > 0) {
        const prev = steps[currentStep - 1];
        document.getElementById(`step${prev}`).classList.remove('active');
        document.getElementById(`step${prev}`).classList.add('completed');
        document.getElementById(`text${prev}`).classList.remove('loading-dots');
        document.getElementById(`icon${prev}`).innerHTML = '<i class="fas fa-check"></i>';
      }

      if (currentStep < totalSteps) {
        const step = steps[currentStep];
        document.getElementById(`step${step}`).classList.add('active');
        document.getElementById(`text${step}`).classList.add('loading-dots');
        document.getElementById(`icon${step}`).innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        const progress = Math.min(100, Math.round((step) / totalSteps * 100));
        progressBar.style.width = progress + '%';
        progressBar.setAttribute('aria-valuenow', progress);
        progressPercent.textContent = progress + '%';

        currentStep++;
      } else {
        clearInterval(interval);
        setTimeout(function() {
          form.submit();
        }, 1000);
      }
    }, 1500);
  }

  // Filter gejala saat mengetik di search bar
  const searchInput = document.getElementById('searchGejala');
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const keyword = this.value.toLowerCase();
      const rows = document.querySelectorAll('#gejalaTable tr');
      
      rows.forEach(row => {
        const label = row.querySelector('label').innerText.toLowerCase();
        row.style.display = label.includes(keyword) ? '' : 'none';
      });
    });
  }

  // Add a reset listener that also updates the counter
  const resetButton = document.querySelector('button[type="reset"]');
  if (resetButton) {
    resetButton.addEventListener('click', function() {
      setTimeout(updateCounter, 10); // Small delay to ensure checkboxes are reset
    });
  }
});
</script>
{% endblock %}